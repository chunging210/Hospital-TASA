<!-- 右側邊欄：新增/編輯會議室 -->
<link rel="stylesheet" href="/css/sysroom.css">

<div ref="roomoffcanvas" class="offcanvas offcanvas-end offcanvas-create" tabindex="-1" id="offcanvasRoomCreate"
     aria-labelledby="offcanvasRoomCreateLabel">
    <div class="offcanvas-header border-bottom">
        <h5 id="offcanvasRoomCreateLabel" class="mb-0">
            <i :class="room.vm.Id ? 'mdi mdi-home-edit' : 'mdi mdi-home-plus'"></i> {{ room.vm.Id ? '編輯會議室' : '新增會議室' }}
        </h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body">
        <form id="createRoomForm" class="needs-validation" novalidate>

            <!-- 基本資訊區塊 -->
            <div class="form-section">
                <h6>基本資訊</h6>

                <div class="mb-3">
                    <label class="form-label form-label-custom">會議室名稱 <span class="text-danger">*</span></label>
                    <input v-model="room.vm.Name" type="text" class="form-control" placeholder="請輸入會議室名稱" required>
                    <div class="invalid-feedback">請輸入會議室名稱</div>
                </div>

                <div class="mb-3" v-if="isAdmin">
                    <label class="form-label form-label-custom">分院 <span class="text-danger">*</span></label>
                    <select v-model="room.vm.DepartmentId" class="form-control" required>
                        <option :value="null">請選擇分院</option>
                        <option v-for="dept in department.list" :key="dept.Id" :value="dept.Id">
                            {{ dept.Name }}
                        </option>
                    </select>
                    <div class="invalid-feedback">請選擇分院</div>
                </div>

                <div class="mb-3">
                    <label class="form-label form-label-custom">大樓名稱 <span class="text-danger">*</span></label>
                    <input v-model="room.vm.Building" type="text" class="form-control" placeholder="請輸入大樓名稱" required>
                    <div class="invalid-feedback">請輸入大樓名稱</div>
                </div>

                <div class="mb-3">
                    <label class="form-label form-label-custom">樓層 <span class="text-danger">*</span></label>

                    <input v-model.trim="room.vm.Floor" type="text" class="form-control" placeholder="例：B1、B2、1、5、10、RF"
                           maxlength="4" required />

                    <div class="form-text text-muted">
                        可輸入格式：B1~B99、1~99、1F~99F、RF
                    </div>

                    <div class="invalid-feedback">
                        請輸入正確樓層格式
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label form-label-custom">會議室說明</label>
                    <textarea v-model="room.vm.Description" class="form-control" rows="4" placeholder="請輸入會議室簡介、用途或特色..."
                              required></textarea>
                    <div class="invalid-feedback">請輸入會議室說明</div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label form-label-custom">人數 <span class="text-danger">*</span></label>
                        <input v-model.number="room.vm.Capacity" type="number" class="form-control" placeholder="請輸入人數"
                               min="1" step="1" required>
                        <div class="invalid-feedback">請輸入人數（最少 1 人）</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-custom">面積（㎡） <span class="text-danger">*</span></label>
                        <input v-model.number="room.vm.Area" type="number" class="form-control" placeholder="請輸入面積" min="1"
                               step="0.01" required>
                        <div class="invalid-feedback">請輸入面積（㎡）</div>
                    </div>
                </div>

                <!-- 維修中 (僅編輯模式) -->
                <div v-if="room.vm.Id" class="mt-3">
                    <div class="form-check">
                        <input v-model="room.vm.Status" :true-value="1" :false-value="0" type="checkbox"
                            class="form-check-input" id="editStatusCheck">
                        <label class="form-check-label" for="editStatusCheck">維修中</label>
                    </div>
                </div>
            </div>

            <!-- 收費設定區塊 -->
            <div class="form-section pricing-section-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">收費設定 <span class="text-danger">*</span></h6>
                        <small class="text-muted">管理不同時段的場地租借費用</small>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" @@click="room.addTimeSlot()">
                        新增時段
                    </button>
                </div>

                <!-- 表頭 -->
                <div class="pricing-table-header">
                    <div class="pricing-col-name font-size-16">時段名稱</div>
                    <div class="pricing-col-time font-size-16">時間範圍</div>
                    <div class="pricing-col-price font-size-16">平日價格</div>
                    <div class="pricing-col-price font-size-16">假日價格</div>
                    <div class="pricing-col-price font-size-16">場布價格</div>
                    <div class="pricing-col-action font-size-16">操作</div>
                </div>

                <!-- 時段列表 -->
                <div v-for="(slot, index) in room.timeSlots" :key="slot.Id" class="pricing-table-row">
                    <div class="pricing-col-name">
                        <input v-model="slot.Name" type="text" class="form-control form-control-sm"
                               placeholder="時段名稱">
                    </div>
                    <div class="pricing-col-time">
                        <div class="time-picker-group">
                            <select v-model="slot.StartHour" class="form-select-sm time-hour">
                                <option v-for="h in 24" :key="h-1" :value="String(h-1).padStart(2,'0')">{{ String(h-1).padStart(2,'0') }}</option>
                            </select>
                            <span class="time-colon">:</span>
                            <select v-model="slot.StartMin" class="form-select-sm time-min">
                                <option value="00">00</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                        <span class="text-muted mx-1">—</span>
                        <div class="time-picker-group">
                            <select v-model="slot.EndHour" class="form-select-sm time-hour">
                                <option v-for="h in 24" :key="h-1" :value="String(h-1).padStart(2,'0')">{{ String(h-1).padStart(2,'0') }}</option>
                            </select>
                            <span class="time-colon">:</span>
                            <select v-model="slot.EndMin" class="form-select-sm time-min">
                                <option value="00">00</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                    </div>
                    <div class="pricing-col-price">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input v-model.number="slot.Price" type="number" class="form-control" min="0">
                        </div>
                    </div>
                    <div class="pricing-col-price">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input v-model.number="slot.HolidayPrice" type="number" class="form-control" min="0">
                        </div>
                    </div>
                    <div class="pricing-col-price">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input v-model.number="slot.SetupPrice" type="number" class="form-control" min="0" placeholder="選填">
                        </div>
                    </div>
                    <div class="pricing-col-action">
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                @@click="room.removeTimeSlot(index)">
                            <span class="material-icons icons font-size-18">delete_outline</span>
                        </button>
                    </div>
                </div>

                <div class="text-muted small mt-3">
                    <span class="text-danger">*</span> 平日指週一至週五，假日指週六、週日及國定假日。系統將自動根據預約日期套用價格。
                </div>
            </div>

            <!-- 媒體資料區塊 -->
            <div class="form-section">
                <h6>會議室媒體資料</h6>
                <div class="mb-3">
                    <label class="form-label form-label-custom">
                        上傳圖片/影片
                        <span class="text-muted small">(選填，可多個)</span>
                    </label>
                    <div class="file-upload-area"
                         :class="{ 'has-file': room.mediaFiles.length > 0 }"
                         @@click="room.triggerMediaUpload()"
                         @@dragover.prevent
                         @@drop.prevent="room.handleMediaDrop($event)">

                        <!-- 未上傳狀態 -->
                        <div v-if="room.mediaFiles.length === 0" class="upload-placeholder">
                            <i class="bx bx-cloud-upload" style="font-size: 48px;"></i>
                            <p class="mb-1">點擊上傳或拖曳檔案至此</p>
                            <small class="text-muted">支援圖片及影片格式</small>
                        </div>

                        <!-- 已上傳檔案列表 -->
                        <div v-else class="uploaded-files-list" @@click.stop>
                            <div v-for="media in room.mediaFiles" :key="media.Id" class="uploaded-file-item">
                                <img v-if="media.type === 'image'" :src="media.src" class="media-thumb">
                                <video v-else class="media-thumb"><source :src="media.src"></video>
                                <div class="file-info">
                                    <strong>{{ media.name || '媒體檔案' }}</strong>
                                    <small class="text-muted d-block">{{ media.type === 'image' ? '圖片' : '影片' }}</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        @@click.stop="room.removeMedia(media.Id)">
                                    移除
                                </button>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2"
                                    @@click.stop="room.triggerMediaUpload()">
                                新增更多檔案
                            </button>
                        </div>
                    </div>
                    <input type="file" id="mediaUpload" accept="image/*,video/*" multiple
                           @@change="room.handleMediaUpload" style="display: none;">
                </div>
            </div>

            <!-- 租借權限設定區塊 -->
            <div class="form-section">
                <h6>租借權限設定 <span class="text-danger">*</span></h6>
                <div class="rental-options">
                    <!-- 對內 -->
                    <div class="rental-option rental-option-internal" @@click="room.vm.BookingSettings = 0"
                         :class="{ active: room.vm.BookingSettings === 0 }">
                        <i class="bx bx-building"></i>
                        <h6>對內</h6>
                        <small>僅限公司內部使用</small>
                    </div>

                    <!-- 對內外 -->
                    <div class="rental-option rental-option-external" @@click="room.vm.BookingSettings = 1"
                         :class="{ active: room.vm.BookingSettings === 1 }">
                        <i class="bx bx-group"></i>
                        <h6>對內外</h6>
                        <small>內部及外部客戶可租借</small>
                    </div>

                    <!-- 不開放 -->
                    <div class="rental-option rental-option-closed" @@click="room.vm.BookingSettings = 2"
                         :class="{ active: room.vm.BookingSettings === 2 }">
                        <i class="bx bx-block"></i>
                        <h6>不開放</h6>
                        <small>暫不開放租借</small>
                    </div>

                    <!-- 免費開放 -->
                    <div class="rental-option rental-option-free" @@click="room.vm.BookingSettings = 3"
                         :class="{ active: room.vm.BookingSettings === 3 }">
                        <i class="bx bx-gift"></i>
                        <h6>免費開放</h6>
                        <small>免費提供使用</small>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h6>會議室管理者</h6>

                <div class="mb-3">
                    <label class="form-label form-label-custom">指定管理者 (選填)</label>

                    <!-- 已選擇的管理者 -->
                    <div v-if="manager.selectedManager.value"
                         class="d-flex justify-content-between manager-area align-items-center">
                        <div class="d-flex flex-column">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">
                                    {{ manager.selectedManager.value.RoleDisplay }}
                                </span>
                                <strong>{{ manager.selectedManager.value.Name }}</strong>
                            </div>
                            <small class="text-muted mt-2">
                                <span class="material-icons icons font-size-18 me-1">mail_outline</span>
                                {{ manager.selectedManager.value.Email }}
                            </small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" @@click="manager.clearSelection()" style="height: 34.56px">
                            移除
                        </button>
                    </div>

                    <!-- 搜尋管理者 -->
                    <div v-else>
                        <input v-model="manager.searchKeyword.value" type="text" class="form-control mb-2"
                               placeholder="搜尋使用者姓名或 Email...">

                        <div class="manager-list"
                             style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                            <div v-for="user in manager.filteredList.value" :key="user.Id"
                                 class="manager-item p-2 border-bottom hover-bg-light" style="cursor: pointer;"
                                @@click="manager.selectManager(user)">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary" style="font-size: 0.7rem;">
                                                {{ user.RoleDisplay }}
                                            </span>
                                            <strong>{{ user.Name }}</strong>
                                            <small class="text-muted d-block">{{ user.Email }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="manager.filteredList.value.length === 0" class="p-3 text-center text-muted">
                                查無使用者
                            </div>
                        </div>
                    </div>

                    <div class="form-text text-muted">
                        設定後,此會議室的預約審核通知將寄給指定管理者
                    </div>
                </div>
            </div>

            <!-- ✅ 聲明書上傳區塊 -->
            <div class="form-section">
                <h6>聲明書設定</h6>

                <!-- 已有聲明書 (編輯模式) -->
                <div v-if="room.vm.Id && room.vm.AgreementPath && !room.form.agreementFileName" class="alert alert-info py-2 mb-3">
                    目前聲明書：
                    <a :href="room.vm.AgreementPath" target="_blank" class="ms-1">查看</a>
                    <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                            @@click="room.removeExistingAgreement()">移除</button>
                </div>

                <!-- 未上傳：顯示上傳區 -->
                <div v-if="!room.form.agreementFileName" class="file-upload-area"
                     @@click="room.triggerAgreementUpload()">
                    <div class="upload-placeholder">
                        <p class="mb-1">點擊上傳聲明書</p>
                        <small class="text-muted">僅支援 PDF 格式</small>
                    </div>
                </div>

                <!-- 已上傳：顯示檔名 + 移除 -->
                <div v-else class="has-file">
                    <div class="uploaded-files-list">
                        <div class="uploaded-file-item">
                            <strong  class="file-info">{{ room.form.agreementFileName }}</strong>
                            <button type="button" class="btn btn-sm btn-outline-danger" @@click="room.clearAgreement()">
                                移除
                            </button>
                        </div>

                    </div>
                </div>
                <input type="file" id="agreementUpload" @@change="room.handleAgreementUpload($event)"
                       accept=".pdf" style="display: none;">

                <p class="text-muted small mt-2">
                    若未上傳，將使用系統預設聲明書
                </p>
            </div>
        </form>
    </div>

    <!-- 固定底部按鈕 -->
    <div class="offcanvas-footer d-flex gap-2 justify-content-end">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">取消</button>
        <button type="button" class="btn btn-primary" @@click="room.save()">{{ room.vm.Id ? '儲存變更' : '確定新增' }}</button>
    </div>
</div>