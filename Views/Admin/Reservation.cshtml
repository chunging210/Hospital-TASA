<link rel="stylesheet" href="/css/reservation.css">
<div class="page-content">
    <div class="container-fluid vstack gap-3">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <!-- 標題 -->
                    <div class="col-xl-auto col-sm-12 text-branding d-flex align-items-center">
                        <span class="material-icons">assignment_turned_in</span>預約審核
                    </div>

                    <!-- 搜尋 -->
                    <div class="col-12 col-lg-4">
                        <div class="input-group">
                            <div class="form-floating">
                                <input v-model="reservation.query.keyword" @@blur="reservation.getList" type="text"
                                    class="form-control" placeholder="關鍵字">
                                <label>關鍵字</label>
                            </div>
                            <button @@click="reservation.getList" class="btn btn-secondary"><span
                                    class="material-icons">search</span></button>
                        </div>
                    </div>

                    <!-- 狀態篩選 -->
                    <div class="col-12 col-lg-3">
                        <select v-model="reservation.query.status" @@change="reservation.getList" class="form-select">
                            <option value="">全部狀態</option>
                            <option value="1">待審核</option>
                            <option value="0">已拒絕</option>
                            <option value="2">待繳費</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <table class="table table-hover">
                    <caption>預約審核列表</caption>
                    <thead>
                        <tr class="table-light">
                            <th style="width:120px;">預約單號</th>
                            <th>申請人</th>
                            <th>日期</th>
                            <th>時間</th>
                            <th>會議室</th>
                            <th>金額</th>
                            <th>狀態</th>
                            <th>動作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in reservation.list" :key="item.Id">
                            <td>{{ item.bookingNo }}</td>
                            <td>{{ item.applicantName }}</td>
                            <td>{{ item.date }}</td>
                            <td>{{ item.time }}</td>
                            <td>{{ item.roomName }}</td>
                            <td>NT${{ item.totalAmount.toLocaleString() }}</td>
                            <td>
                                <span v-if="item.status === '待審核'" class="badge bg-warning">待審核</span>
                                <span v-else-if="item.status === '核准'" class="badge bg-success">核准</span>
                                <span v-else class="badge bg-danger">拒絕</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" @@click="reservation.openReview(item)"
                                    data-bs-toggle="offcanvas" data-bs-target="#reviewDrawer">
                                    <span class="material-icons">edit</span> 審核
                                </button>
                            </td>
                        </tr>
                        <tr v-if="reservation.list.length === 0">
                            <td colspan="8" class="text-center">查無資料</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ===== 審核抽屜 ===== -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="reviewDrawer" aria-labelledby="reviewDrawerLabel">
    <div class="offcanvas-header">
        <h5 id="reviewDrawerLabel">審核預約 <small class="text-muted">{{ reservation.currentReview.bookingNo }}</small></h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <!-- 基本資料 -->
        <div class="border rounded p-3 bg-body-tertiary mb-3">
            <div class="row g-2 small">
                <div class="col-md-6"><strong>申請人：</strong>{{ reservation.currentReview.applicantName }}</div>
                <div class="col-md-6"><strong>會議室：</strong>{{ reservation.currentReview.roomName }}</div>
                <div class="col-md-6"><strong>日期：</strong>{{ reservation.currentReview.date }}</div>
            </div>
        </div>

        <!-- ✅ 新增：預約時段明細 -->
        <div v-if="reservation.currentReview.slots && reservation.currentReview.slots.length > 0" class="mb-4">
            <h6 class="mb-2">
                <span class="material-icons">schedule</span>
                預約時段明細
            </h6>

            <div class="slot-list">
                <div v-for="(slot, index) in reservation.currentReview.slots" :key="slot.id"
                    class="d-flex align-items-center gap-3 mb-2 p-3 border rounded" style="background: #f8f9fa;">

                    <span class="badge bg-primary rounded-pill">{{ index + 1 }}</span>

                    <div class="flex-grow-1 small">
                        <div class="fw-bold">{{ slot.slotDate }}</div>
                        <div class="text-muted">{{ slot.startTime }} ~ {{ slot.endTime }}</div>
                    </div>

                </div>
            </div>

            <div class="mt-3 p-2 bg-light rounded text-center small">
                <strong>共 {{ reservation.currentReview.slots.length }} 個時段</strong>
            </div>
        </div>

        <hr>

        <hr>

        <form class="row g-3">
            <!-- 審核決策 -->
            <div class="col-12">
                <label class="form-label">審核結果</label>
                <div class="d-flex gap-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="rw-result" id="rw-approve" value="approve"
                            v-model="reservation.vm.result">
                        <label class="form-check-label" for="rw-approve">核准</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="rw-result" id="rw-reject" value="reject"
                            v-model="reservation.vm.result">
                        <label class="form-check-label" for="rw-reject">拒絕</label>
                    </div>
                </div>
            </div>

            <!-- 拒絕原因 -->
            <div v-if="reservation.vm.result === 'reject'" class="col-12">
                <label class="form-label">拒絕原因 <span class="text-danger">*</span></label>
                <textarea class="form-control" v-model="reservation.vm.rejectReason" rows="2" placeholder="請填寫拒絕原因"
                    required></textarea>
            </div>

            <!-- 折扣設定 -->
            <div v-if="reservation.vm.result === 'approve'" class="col-12">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">折扣方式</label>
                        <select class="form-select" v-model="reservation.vm.discountType">
                            <option value="none">無折扣</option>
                            <option value="percent">百分比折扣 (%)</option>
                            <option value="amount">金額折扣 (NT$)</option>
                            <option value="free">免單</option>
                        </select>
                    </div>

                    <div v-if="reservation.vm.discountType === 'percent'" class="col-md-6">
                        <label class="form-label">折扣％</label>
                        <div class="input-group">
                            <input type="number" class="form-control" v-model.number="reservation.vm.discountPercent"
                                min="0" max="100" step="1">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>

                    <div v-if="reservation.vm.discountType === 'amount'" class="col-md-6">
                        <label class="form-label">折扣金額 (NT$)</label>
                        <input type="number" class="form-control" v-model.number="reservation.vm.discountAmount" min="0"
                            step="1">
                    </div>

                    <div v-if="reservation.vm.discountType !== 'none'" class="col-12">
                        <label class="form-label">
                            原因
                            <span v-if="reservation.vm.discountType === 'free'" class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" v-model="reservation.vm.discountReason" rows="2"
                            :required="reservation.vm.discountType === 'free'"></textarea>
                    </div>

                    <!-- 價格明細 -->
                    <div class="col-12">
                        <div class="border rounded p-3 bg-body-secondary">
                            <h6 class="mb-3">價格明細</h6>
                            <ul class="list-unstyled mb-0">
                                <li><span class="text-muted">場地費：</span><strong>NT${{
                                        reservation.pricing.place.toLocaleString() }}</strong></li>
                                <li><span class="text-muted">器材費：</span><strong>NT${{
                                        reservation.pricing.equipment.toLocaleString() }}</strong></li>
                                <li><span class="text-muted">攤位費：</span><strong>NT${{
                                        reservation.pricing.booth.toLocaleString() }}</strong></li>
                                <li><span class="text-muted">折扣：</span><strong>NT${{
                                        reservation.pricing.discount.toLocaleString() }}</strong></li>
                            </ul>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">合計：</span>
                                <strong class="text-primary">NT${{ reservation.pricing.final.toLocaleString()
                                    }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 按鈕 -->
            <div class="col-12 d-flex gap-2" style="justify-content: flex-end;">
                <button type="button" @@click="reservation.submitReview" class="btn btn-primary">確認送出</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">取消</button>
            </div>
        </form>
    </div>
</div>