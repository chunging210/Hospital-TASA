<!-- calendar -->
<link rel="stylesheet" href="/css/sysroom.css">

<div class="page-content" v-cloak>
    <div class="container-fluid vstack gap-3">
        <div class="card">
            <div class="card-header mx-4 mt-3">
                <div class="row align-items-center">
                    <!-- Title -->
                    <div class="col-auto text-branding align-middle">
                        <span class="material-icons">meeting_room</span>
                        會議室總覽
                    </div>

                    <div v-if="isAdmin" class="col-auto">
                        <select class="form-select" v-model="selectedDepartment" style="min-width: 180px;">
                            <option :value="null">請選擇分院...</option>
                            <option v-for="dept in departments" :key="dept.Id" :value="dept.Id">
                                {{ dept.Name }}
                            </option>
                        </select>
                    </div>

                    <!-- 大樓下拉 -->
                    <div class="col-auto">
                        <select class="form-select" v-model="selectedBuilding" :key="selectedDepartment"
                                style="min-width: 180px;">
                            <option value="">請選擇大樓...</option>
                            <option v-for="b in buildings" :key="b.Building" :value="b.Building">
                                {{ b.Building }}
                            </option>
                        </select>
                    </div>

                    <!-- 樓層下拉 -->
                    <div class="col-auto">
                        <select class="form-select" v-model="selectedFloor" :disabled="!selectedBuilding"
                                style="min-width: 180px;">
                            <option value="">請選擇樓層...</option>
                            <option v-for="f in floorOptions" :key="f" :value="f">
                                {{ f }}
                            </option>
                        </select>
                    </div>

                    <div class="col-auto ms-auto">
                        <button type="button" class="btn btn-primary font-size-24" data-bs-toggle="modal"
                                data-bs-target="#smartSearchModal">
                            智慧搜尋
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                @* <div v-if="isSearchMode" class="search-results-header">
                    <h5>
                        搜尋結果 ({{ room.list.length }} 筆)
                    </h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm" @@click="clearSearchResults">
                        返回總覽
                    </button>
                </div> *@

                <div v-if="room.list.length === 0" class="text-center py-5">
                    <h5 class="text-muted mt-3">
                        {{ isSearchMode ? '沒有找到符合條件的會議室' : '查無資料' }}
                    </h5>
                    <p v-if="isSearchMode" class="text-muted">請調整搜尋條件</p>
                </div>

                <div v-else-if="isSearchMode" class="search-result-list">
                    <div v-for="item in room.list" :key="item.Id" class="search-result-card">
                        <div class="search-result-image">
                            <img v-if="item.Images && item.Images.length > 0 && !room.isVideoFile(item.Images[0])"
                                 :src="item.Images[0]" alt="會議室圖片">
                            <video v-else-if="item.Images && item.Images.length > 0 && room.isVideoFile(item.Images[0])"
                                   muted style="object-fit:cover;">
                                <source :src="item.Images[0]" type="video/mp4">
                            </video>
                            <div v-else class="search-result-no-image">
                                <span class="material-icons" style="font-size:48px;color:#ccc;">meeting_room</span>
                            </div>
                        </div>

                        <div class="search-result-info">
                            <div class="search-result-name" @@click="room.openDetail(item.Id)">{{ item.Name }}</div>
                            <div class="search-result-location">
                                {{ item.Building }} {{ item.Floor }}樓<span v-if="item.Number"> | {{ item.Number
                                }}</span>
                            </div>
                            <div class="search-result-meta">
                                容量：{{ item.Capacity ?? '-' }} 人 | 面積：{{ item.Area ?? '-' }} 平方公尺
                            </div>
                            <div class="search-result-meta">
                                設備數量：{{ item.EquipmentCount ?? 0 }} 項
                            </div>
                            <div class="search-result-tags" v-if="item.Equipments && item.Equipments.length > 0">
                                <span v-for="eq in item.Equipments.slice(0, 3)" :key="eq.Name || eq"
                                      class="search-result-tag">
                                    <span class="material-icons icons" style="font-size:14px;">devices</span>
                                    {{ eq.Name || eq }}
                                </span>
                                <span v-if="item.Equipments.length > 3" class="search-result-tag-more">
                                    +{{ item.Equipments.length - 3 }} 項
                                </span>
                            </div>
                        </div>

                        <div class="search-result-actions">
                            <button class="btn btn-outline-primary" @@click.stop="room.openDetail(item.Id)">
                                <span class="material-icons icons">visibility</span> 了解更多
                            </button>
                            <button class="btn btn-outline-primary" @@click.stop="room.goReserve(item)">
                                <span class="material-icons icons">event_available</span> 立即預約
                            </button>
                        </div>
                    </div>
                </div>

                <div v-else class="room-grid">
                    <div v-for="item in room.list" :key="item.Id" class="room-card">

                        <div class="room-card-header">
                            <div class="room-name">{{ item.Name }}</div>
                            <div class="room-info">
                                {{ item.Building }} {{ item.Floor }} 樓 | {{ item.Number }}
                            </div>
                        </div>

                        <div class="room-preview">
                            <div v-if="item.Images && item.Images.length > 0 && !room.isVideoFile(item.Images[item._imgIndex || 0])"
                                 style="width: 100%; height: 100%; background-size: cover; background-position: center;"
                                 :style="{ backgroundImage: `url('${item.Images[item._imgIndex || 0]}')` }">
                            </div>

                            <video
                                v-else-if="item.Images && item.Images.length > 0 && room.isVideoFile(item.Images[item._imgIndex || 0])"
                                controls autoplay muted
                                style="width: 100%; height: 100%; object-fit: cover; background: #000; display: block;">
                                <source :src="item.Images[item._imgIndex || 0]" type="video/mp4">
                                你的瀏覽器不支援視訊播放
                            </video>

                            <div v-else
                                 style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">
                                暫無圖片
                            </div>

                            <button v-if="item.Images?.length > 1" class="carousel-btn prev"
                                @@click.stop="room.prevCardImage(item)">
                                ‹
                            </button>

                            <button v-if="item.Images?.length > 1" class="carousel-btn next"
                                @@click.stop="room.nextCardImage(item)">
                                ›
                            </button>
                        </div>

                        <div class="room-card-body">
                            <div class="room-details">
                                <div class="detail-row">
                                    <span class="detail-label">人數</span>
                                    <span class="detail-value">{{ item.Capacity ?? '-' }} 人</span>
                                </div>

                                <div class="detail-row">
                                    <span class="detail-label">面積</span>
                                    <span class="detail-value">{{ item.Area ?? '-' }} ㎡</span>
                                </div>
                                <div class="detail-row equipment-hover" @@mouseenter="showRoomPopover(item, $event)"
                                    @@mouseleave="hideRoomPopover()">
                                    <span class="detail-label">設備數量</span>
                                    <span class="detail-value">{{ item.EquipmentCount ?? '-' }} 項設備
                                        <span class="material-icons"
                                              style="font-size: 14px; vertical-align: middle; color: #6c757d;">info_outline</span>
                                    </span>
                                </div>
                            </div>

                            <div class="action-buttons mt-3">
                                <button class="btn btn-view btn-outline-primary"
                                    @@click.stop="room.openDetail(item.Id)">
                                    <span class="material-icons icons">visibility</span>
                                    了解更多
                                </button>
                                <button class="btn btn-edit btn-outline-primary" @@click.stop="room.goReserve(item)">
                                    <span class="material-icons icons">event_available</span>
                                    立即預約
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="!isSearchMode">
                    <page ref="roompage" :per-page="6" :per-page-option="[6,9,12,18]" @@reload="room.getList">
                    </page>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Room Popover -->
<div v-if="roomPopover.visible" class="room-popover"
     :style="{ top: roomPopover.top + 'px', left: roomPopover.left + 'px' }" @@mouseenter="keepRoomPopover()"
    @@mouseleave="hideRoomPopover()">
    <div v-if="roomPopover.loading" class="text-center p-3">
        <div class="spinner-border spinner-border-sm text-primary"></div>
        <span class="ms-2 small">載入中...</span>
    </div>
    <template v-else-if="roomPopover.data">
        <!-- 標題區 -->
        <div class="popover-header-section">
            <div class="popover-room-name">{{ roomPopover.data.Name }}</div>
            <div class="popover-room-location">{{ roomPopover.data.Building }} {{ roomPopover.data.Floor }}樓</div>
        </div>

        <!-- 收費制度 -->
        <div class="popover-section">
            <div class="popover-section-title">
                <span class="material-icons">paid</span> 收費制度
            </div>
            <div v-if="roomPopover.data.PricingDetails?.length > 0" class="popover-pricing-list">
                <div v-for="p in roomPopover.data.PricingDetails" :key="p.Name" class="popover-pricing-item">
                    <span>{{ p.StartTime }}-{{ p.EndTime }}</span>
                    <span class="popover-pricing-price">NT$ {{ p.Price }}</span>
                </div>
            </div>
            <div v-else class="text-muted small">無收費資訊</div>
        </div>

        <!-- 設備總覽 -->
        <div class="popover-section">
            <div class="popover-section-title">
                <span class="material-icons">construction</span> 設備總覽
            </div>
            <div v-if="roomPopover.data.Equipment?.length > 0" class="popover-equipment-grid">
                <div v-for="eq in roomPopover.data.Equipment" :key="eq.Id" class="popover-equipment-item">
                    @* <span class="material-icons popover-equipment-icon">devices</span> *@
                    <span>{{ eq.Name }}</span>
                </div>
            </div>
            <div v-else class="text-muted small">無設備資訊</div>
        </div>
    </template>
</div>

<!-- 智慧搜尋 Modal -->
<div class="modal fade" id="smartSearchModal" tabindex="-1" aria-labelledby="smartSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smartSearchModalLabel">
                    <i class="mdi mdi-magnify"></i> 智慧搜尋
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body smart-search-body">
                <!-- 第一排:會議時間 + 人數需求 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="section-title">
                            <i class="mdi mdi-calendar-outline text-primary me-2"></i>
                            會議時間
                        </h6>
                        <input type="date" class="form-control" id="searchDate" v-model="smartSearch.date">
                        <small class="text-muted">若不選擇日期,將顯示所有符合條件的會議室</small>
                    </div>

                    <div class="col-md-6">
                        <h6 class="section-title">
                            <i class="mdi mdi-account-group text-success me-2"></i>
                            人數需求
                        </h6>
                        <div class="input-group">
                            <input type="number" class="form-control" id="searchCapacity"
                                   v-model.number="smartSearch.minCapacity" min="1" placeholder="例如:20">
                            <span class="input-group-text">人</span>
                        </div>
                    </div>
                </div>

                <!-- 第二排:設備需求 -->
                <div class="mb-4">
                    <h6 class="section-title">
                        <i class="mdi mdi-tools text-warning me-2"></i>
                        設備需求
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="equipment-card">
                                <input type="checkbox" class="form-check-input d-none" value="1"
                                       v-model="smartSearch.equipmentTypes">
                                <i class="mdi mdi-projector text-primary fs-3 me-2"></i> 影像設備
                            </label>
                        </div>
                        <div class="col-md-3">
                            <label class="equipment-card">
                                <input type="checkbox" class="form-check-input d-none" value="2"
                                       v-model="smartSearch.equipmentTypes">
                                <i class="mdi mdi-microphone text-success fs-3 me-2"></i> 音響設備
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 第三排:關鍵字 + 地點 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="section-title">
                            <i class="mdi mdi-text-search text-info me-2"></i>
                            關鍵字搜尋
                        </h6>
                        <input type="text" class="form-control" id="searchKeyword" v-model="smartSearch.keyword"
                               placeholder="例如:演講廳、國際...">
                    </div>

                    <div class="col-md-6">
                        <h6 class="section-title">
                            <i class="mdi mdi-map-marker text-danger me-2"></i>
                            地點
                        </h6>
                        <select class="form-select" id="searchBuilding" v-model="smartSearch.building">
                            <option value="">不限大樓</option>
                            <option v-for="b in buildings" :key="b.Building" :value="b.Building">
                                {{ b.Building }}
                            </option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-close"></i> 取消
                </button>
                <button type="button" class="btn btn-danger" @@click="clearSmartSearch">
                    <i class="mdi mdi-refresh"></i> 重置
                </button>
                <button type="button" class="btn btn-primary" @@click="performSmartSearch">
                    <i class="mdi mdi-magnify"></i> 開始搜尋
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 詳細 Modal（沿用你現有那份，Vue 已可正常吃到資料） -->
<partial name="_SysRoomDetail" />