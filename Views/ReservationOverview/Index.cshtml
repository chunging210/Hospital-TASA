<link rel="stylesheet" href="/css/reservation.css">

<div id="app" class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <!-- Header -->
                        <div class="card-header mx-4 mt-3">
                            <div class="row align-items-center">
                                <div class="col-xl-auto col-sm-12 text-branding align-middle">
                                    <i class="mdi mdi-calendar-text-outline"></i> 預約總覽
                                </div>
                                <div class="col-xl-4 col-sm-12">
                                    <div class="search-box">
                                        <div class="position-relative">
                                            <input type="text" class="form-control" v-model="searchQuery"
                                                placeholder="搜尋預約單號、預約者...">
                                            <i class="bx bx-search-alt search-icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-3 col-sm-12">
                                    <input type="text" class="form-control" v-model="dateRange" placeholder="選擇日期範圍" />
                                </div>
                                <div class="col-xl-auto col-sm-12">
                                    <select class="form-select" v-model="paymentStatusFilter">
                                        <option value="">付款狀態</option>
                                        <option value="未付款">未付款</option>
                                        <option value="已付款">已付款</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="card-body">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation" v-if="isAdmin">
                                    <button class="nav-link" :class="{ active: activeTab === 'all' }"
                                        @@click="activeTab = 'all'" type="button">
                                        所有預約
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" :class="{ active: activeTab === 'personal' }"
                                        @@click="activeTab = 'personal'" type="button">
                                        個人預約
                                    </button>
                                </li>
                            </ul>

                            <div class="table-responsive mx-3 mt-4">
                                <!-- Tab Content -->
                                <div class="tab-content">
                                    <!-- 所有預約 Tab -->
                                    <div v-show="activeTab === 'all' && isAdmin">
                                        <table class="table align-middle table-nowrap mb-0 table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="align-middle">預約單號</th>
                                                    <th class="align-middle">預約者</th>
                                                    <th class="align-middle">預約日期</th>
                                                    <th class="align-middle">時間</th>
                                                    <th class="align-middle">會議室</th>
                                                    <th class="align-middle">繳費截止日</th>
                                                    <th class="align-middle">付款方式</th>
                                                    <th class="align-middle">金額</th>
                                                    <th class="align-middle">審核狀態</th>
                                                    <th class="align-middle">付款狀態</th>
                                                    <th class="align-middle">成本中心代碼</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="item in filteredAllReservations" :key="item.id"
                                                    class="row-click" role="button" @@click="openDetailDrawer(item)">
                                                    <td>{{ item.reservationNo }}</td>
                                                    <td>{{ item.reserverName }}</td>
                                                    <td>{{ item.reservationDate }}</td>
                                                    <td>{{ item.timeSlot }}</td>
                                                    <td>{{ item.roomName }}</td>
                                                    <td>{{ item.paymentDeadline }}</td>
                                                    <td>{{ getPaymentMethodText(item.paymentMethod) }}</td>
                                                    <td>NT${{ item.amount.toLocaleString() }}</td>
                                                    <td>
                                                        <span class="badge"
                                                            :class="getApprovalStatusClass(item.approvalStatus)">
                                                            {{ item.approvalStatus }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span v-if="item.paymentStatus === '-'"
                                                            class="text-muted">-</span>
                                                        <span v-else class="badge"
                                                            :class="getPaymentStatusClass(item.paymentStatus)">
                                                            {{ item.paymentStatus }}
                                                        </span>
                                                    </td>
                                                    <td>{{ item.costCenter }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- 個人預約 Tab -->
                                    <div v-show="activeTab === 'personal'">
                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap mb-0 table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="align-middle">預約單號</th>
                                                        <th class="align-middle">預約日期</th>
                                                        <th class="align-middle">時間</th>
                                                        <th class="align-middle">會議室</th>
                                                        <th class="align-middle">繳費截止日</th>
                                                        <th class="align-middle">付款方式</th>
                                                        <th class="align-middle">金額</th>
                                                        <th class="align-middle">付款狀態</th>
                                                        <th class="align-middle">成本中心代碼</th>
                                                        <th class="align-middle">審核狀態</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="item in personalReservations" :key="item.id"
                                                        class="row-click" role="button"
                                                        @@click="openDetailDrawer(item)">
                                                        <td>{{ item.reservationNo }}</td>
                                                        <td>{{ item.reservationDate }}</td>
                                                        <td>{{ item.timeSlot }}</td>
                                                        <td>{{ item.roomName }}</td>
                                                        <td>{{ item.paymentDeadline }}</td>
                                                        <td>{{ getPaymentMethodText(item.paymentMethod) }}</td>
                                                        <td>NT${{ item.amount.toLocaleString() }}</td>
                                                        <td>
                                                            <span v-if="item.paymentStatus === '-'"
                                                                class="text-muted">-</span>
                                                            <span v-else class="badge"
                                                                :class="getPaymentStatusClass(item.paymentStatus)">
                                                                {{ item.paymentStatus }}
                                                            </span>
                                                        </td>
                                                        <td>{{ item.costCenter }}</td>
                                                        <td>
                                                            <span class="badge"
                                                                :class="getApprovalStatusClass(item.approvalStatus)">
                                                                {{ item.approvalStatus }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ 預約詳情 Offcanvas -->
    <div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="bookingDrawer" ref="bookingDrawer">
        <div class="offcanvas-header">
            <h5 class="mb-0 fw-bold">
                預約詳情 <small class="text-muted ms-2">#{{ selectedItem?.reservationNo }}</small>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body" v-if="selectedItem">
            <form class="row g-3">
                <!-- ========== 基本資訊 ========== -->
                <div class="col-12">
                    <h6 class="fw-bold border-bottom pb-2">基本資訊</h6>
                </div>

                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">預約者</label>
                        <label class="form-label col-md-9">{{ selectedItem.reserverName }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">預約日期</label>
                        <label class="form-label col-md-8">{{ selectedItem.reservationDate }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">時間</label>
                        <label class="form-label col-md-8">{{ selectedItem.timeSlot }}</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">會議室</label>
                        <label class="form-label col-md-9">{{ selectedItem.roomName }}</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">繳費截止日</label>
                        <label class="form-label col-md-9">{{ selectedItem.paymentDeadline }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">付款方式</label>
                        <label class="form-label col-md-8">{{ getPaymentMethodText(selectedItem.paymentMethod)
                            }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">金額</label>
                        <label class="form-label col-md-8">NT${{ selectedItem.amount?.toLocaleString() }}</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">成本中心代碼</label>
                        <label class="form-label col-md-9">{{ selectedItem.costCenter || '-' }}</label>
                    </div>
                </div>

                <!-- ========== 審核狀態 ========== -->
                <div class="col-12">
                    <h6 class="fw-bold border-bottom pb-2 mt-3">審核狀態</h6>
                </div>

                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">審核狀態</label>
                        <label class="form-label col-md-9">
                            <span class="badge" :class="getApprovalStatusClass(selectedItem.approvalStatus)">
                                {{ selectedItem.approvalStatus }}
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 拒絕原因 -->
                <div class="col-md-12" v-if="selectedItem.approvalStatus === '審核拒絕' && selectedItem.rejectReason">
                    <div class="alert alert-danger" role="alert">
                        <strong><i class="mdi mdi-alert-circle me-2"></i>拒絕原因:</strong>
                        <p class="mb-0 mt-2">{{ selectedItem.rejectReason }}</p>
                    </div>
                </div>

                <!-- ========== 付款狀態 ========== -->
                <div class="col-12">
                    <h6 class="fw-bold border-bottom pb-2 mt-3">付款狀態</h6>
                </div>

                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">付款狀態</label>
                        <label class="form-label col-md-9">
                            <span v-if="selectedItem.paymentStatus === '-'" class="text-muted">-</span>
                            <span v-else class="badge" :class="getPaymentStatusClass(selectedItem.paymentStatus)">
                                {{ selectedItem.paymentStatus }}
                            </span>
                        </label>
                    </div>

                    <!-- ✅ 只在「個人預約」Tab + 待繳費 + 未付款時顯示付款表單 -->
                    <div
                        v-if="activeTab === 'personal' && selectedItem.approvalStatus === '待繳費' && selectedItem.paymentStatus === '未付款'">

                        <!-- ========== 臨櫃付款欄位 ========== -->
                        <div v-if="isCounterPayment(selectedItem.paymentMethod)" class="mt-4">
                            <h6 class="fw-bold mb-3">
                                <i class="mdi mdi-cash-register me-2"></i>
                                {{ selectedItem.amount === 0 ? '上傳證明文件' : '臨櫃付費 - 上傳憑證' }}
                            </h6>

                            <div v-if="selectedItem.amount === 0" class="alert alert-info">
                                <i class="mdi mdi-information me-2"></i>
                                此預約為免費使用,請上傳證明文件(如:公文、許可證明等)
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    {{ selectedItem.amount === 0 ? '上傳證明文件' : '上傳三聯單(影像或 PDF)' }}
                                    <span class="text-danger">*</span>
                                </label>
                                <input class="form-control" type="file" ref="counterPayFiles"
                                    accept=".jpg,.jpeg,.png,.pdf" multiple required>
                                <div class="form-text">可上傳多檔;支援 JPG / PNG / PDF。</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">備註(選填)</label>
                                <textarea class="form-control" v-model="paymentForm.counterNote" rows="2"
                                    placeholder="例:窗口、收據號碼…"></textarea>
                            </div>

                            <button type="button" class="btn btn-primary" @@click="submitCounterPayment">
                                <i class="mdi mdi-upload me-1"></i> 上傳憑證
                            </button>
                        </div>

                        <!-- ========== 匯款付款欄位 ========== -->
                        <div v-if="isTransferPayment(selectedItem.paymentMethod)" class="mt-4">
                            <h6 class="fw-bold mb-3">
                                <i class="mdi mdi-bank-transfer me-2"></i>匯款付費
                            </h6>

                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label">
                                        轉帳末五碼 <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" v-model="paymentForm.last5"
                                        inputmode="numeric" maxlength="5" placeholder="例如:12345" required>
                                    <div class="form-text">請輸入 5 碼數字。</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">
                                        金額 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">NT$</span>
                                        <input type="number" class="form-control" v-model="paymentForm.amount" min="1"
                                            step="1" required>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">轉帳時間(選填)</label>
                                    <input type="datetime-local" class="form-control" v-model="paymentForm.transferAt">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">備註(選填)</label>
                                    <textarea class="form-control" v-model="paymentForm.transferNote" rows="2"
                                        placeholder="例:銀行代碼、分行…"></textarea>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary mt-3" @@click="submitTransferPayment">
                                <i class="mdi mdi-send me-1"></i> 送出匯款資訊
                            </button>
                        </div>

                        <!-- ========== 成本分攤提示 ========== -->
                        <div v-if="isCostSharingPayment(selectedItem.paymentMethod)" class="mt-4">
                            <div class="alert alert-info">
                                <i class="mdi mdi-information me-2"></i>
                                此預約採用「成本分攤」付款方式,無需手動上傳憑證。
                            </div>
                        </div>

                    </div>
                </div>

            </form>
        </div>
    </div>

</div>