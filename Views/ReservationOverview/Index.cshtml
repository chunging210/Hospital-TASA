<link rel="stylesheet" href="/css/reservation.css">

<div id="app" class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <!-- Header -->
                        <div class="card-header mx-4 mt-3">
                            <div class="row align-items-center">
                                <div class="col-xl-auto col-sm-12 text-branding align-middle">
                                    <i class="mdi mdi-calendar-text-outline"></i> 預約總覽
                                </div>
                                <div class="col-xl-4 col-sm-12">
                                    <div class="search-box">
                                        <div class="position-relative">
                                            <input type="text" class="form-control" v-model="searchQuery"
                                                placeholder="搜尋預約單號、預約者...">
                                            <i class="bx bx-search-alt search-icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-3 col-sm-12">
                                    <input type="text" class="form-control" v-model="dateRange" placeholder="選擇日期範圍" />
                                </div>
                                <div class="col-xl-auto col-sm-12">
                                    <select class="form-select" v-model="paymentStatusFilter">
                                        <option value="">付款狀態</option>
                                        <option value="未付款">未付款</option>
                                        <option value="已付款">已付款</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="card-body">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation" v-if="isAdmin">
                                    <button class="nav-link" :class="{ active: activeTab === 'all' }"
                                        @@click="activeTab = 'all'" type="button">
                                        所有預約
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" :class="{ active: activeTab === 'personal' }"
                                        @@click="activeTab = 'personal'" type="button">
                                        個人預約
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation" v-if="isAdmin">
                                    <button class="nav-link" :class="{ active: activeTab === 'check' }"
                                        @@click="activeTab = 'check'" type="button">
                                        待查帳
                                    </button>
                                </li>
                            </ul>

                            <div class="table-responsive mx-3 mt-4">
                                <!-- Tab Content -->
                                <div class="tab-content">
                                    <!-- 所有預約 Tab -->
                                    <div v-show="activeTab === 'all' && isAdmin">
                                        <table class="table align-middle table-nowrap mb-0 table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="align-middle">預約單號</th>
                                                    <th class="align-middle">預約者</th>
                                                    <th class="align-middle">預約日期</th>
                                                    <th class="align-middle">時間</th>
                                                    <th class="align-middle">會議室</th>
                                                    <th class="align-middle">繳費截止日</th>
                                                    <th class="align-middle">付款方式</th>
                                                    <th class="align-middle">金額</th>
                                                    <th class="align-middle">審核狀態</th>
                                                    <th class="align-middle">付款狀態</th>
                                                    <th class="align-middle">成本中心代碼</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="item in filteredAllReservations" :key="item.id"
                                                    class="row-click" role="button" @@click="openDetailDrawer(item)">
                                                    <td>{{ item.reservationNo }}</td>
                                                    <td>{{ item.reserverName }}</td>
                                                    <td>{{ item.reservationDate }}</td>
                                                    <td>{{ item.timeSlot }}</td>
                                                    <td>{{ item.roomName }}</td>
                                                    <td>{{ item.paymentDeadline }}</td>
                                                    <td>{{ getPaymentMethodText(item.paymentMethod) }}</td>
                                                    <td>NT${{ item.amount.toLocaleString() }}</td>
                                                    <td>
                                                        <span class="badge"
                                                            :class="getApprovalStatusClass(item.approvalStatus)">
                                                            {{ item.approvalStatus }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span v-if="item.paymentStatus === '-'"
                                                            class="text-muted">-</span>
                                                        <span v-else class="badge"
                                                            :class="getPaymentStatusClass(item.paymentStatus)">
                                                            {{ item.paymentStatus }}
                                                        </span>
                                                    </td>
                                                    <td>{{ item.costCenter }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- ✅ 個人預約 Tab (大幅簡化) -->
                                    <div v-show="activeTab === 'personal'">
                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap mb-0 table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="align-middle">預約單號</th>
                                                        <th class="align-middle">預約日期</th>
                                                        <th class="align-middle">時間</th>
                                                        <th class="align-middle">會議室</th>
                                                        <th class="align-middle">繳費截止日</th>
                                                        <th class="align-middle">付款方式</th>
                                                        <th class="align-middle">金額</th>
                                                        <th class="align-middle">付款狀態</th>
                                                        <th class="align-middle">成本中心代碼</th>
                                                        <th class="align-middle">審核狀態</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="item in personalReservations" :key="item.id"
                                                        class="row-click" role="button"
                                                        @@click="openDetailDrawer(item)">
                                                        <td>{{ item.reservationNo }}</td>
                                                        <td>{{ item.reservationDate }}</td>
                                                        <td>{{ item.timeSlot }}</td>
                                                        <td>{{ item.roomName }}</td>
                                                        <td>{{ item.paymentDeadline }}</td>
                                                        <td>{{ getPaymentMethodText(item.paymentMethod) }}</td>
                                                        <td>NT${{ item.amount.toLocaleString() }}</td>
                                                        <td>
                                                            <span v-if="item.paymentStatus === '-'"
                                                                class="text-muted">-</span>
                                                            <span v-else class="badge"
                                                                :class="getPaymentStatusClass(item.paymentStatus)">
                                                                {{ item.paymentStatus }}
                                                            </span>
                                                        </td>
                                                        <td>{{ item.costCenter }}</td>
                                                        <td>
                                                            <span class="badge"
                                                                :class="getApprovalStatusClass(item.approvalStatus)">
                                                                {{ item.approvalStatus }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- 待查帳 Tab -->
                                    <div v-show="activeTab === 'check' && isAdmin">
                                        <div class="d-flex align-items-center mb-3" style="justify-content: flex-end;">
                                            <button type="button" class="btn btn-success me-2"
                                                v-show="checkMode.batchMode" :disabled="checkMode.selectedCount === 0"
                                                @@click="batchApprove">
                                                <i class="mdi mdi-check me-1"></i>
                                                批准選中項目 ({{ checkMode.selectedCount }})
                                            </button>
                                            <button type="button" class="btn btn-outline-danger me-2"
                                                v-show="checkMode.batchMode" :disabled="checkMode.selectedCount === 0"
                                                @@click="batchReject">
                                                <i class="mdi mdi-close me-1"></i>
                                                退回選中項目 ({{ checkMode.selectedCount }})
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary"
                                                @@click="toggleBatchCheckMode">
                                                <i class="mdi mdi-checkbox-multiple-marked me-1"></i>
                                                {{ checkMode.batchMode ? '取消批量' : '批量處理' }}
                                            </button>
                                        </div>

                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap mb-0 table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="check-col"
                                                            :style="{ display: checkMode.batchMode ? 'table-cell' : 'none' }">
                                                            <input class="form-check-input" type="checkbox"
                                                                v-model="checkMode.selectAll"
                                                                @@change="toggleCheckSelectAll">
                                                        </th>
                                                        <th class="align-middle">預約單號</th>
                                                        <th class="align-middle">預約者</th>
                                                        <th class="align-middle">預約日期</th>
                                                        <th class="align-middle">時間</th>
                                                        <th class="align-middle">會議室</th>
                                                        <th class="align-middle">付款方式</th>
                                                        <th class="align-middle">金額</th>
                                                        <th class="align-middle">上傳時間</th>
                                                        <th class="align-middle">審核狀態</th>
                                                        <th class="align-middle">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="item in checkReservations" :key="item.id">
                                                        <td class="check-col"
                                                            :style="{ display: checkMode.batchMode ? 'table-cell' : 'none' }">
                                                            <input class="form-check-input row-check" type="checkbox"
                                                                v-model="item.selected" @@change="updateCheckSelection">
                                                        </td>
                                                        <td>{{ item.reservationNo }}</td>
                                                        <td>{{ item.reserverName }}</td>
                                                        <td>{{ item.reservationDate }}</td>
                                                        <td>{{ item.timeSlot }}</td>
                                                        <td>{{ item.roomName }}</td>
                                                        <td>{{ getPaymentMethodText(item.paymentMethod) }}</td>
                                                        <td>NT${{ item.amount.toLocaleString() }}</td>
                                                        <td>{{ item.uploadTime }}</td>
                                                        <td>
                                                            <span class="badge bg-warning">待審核</span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex gap-1">
                                                                <!-- ✅ 只有現金付款才顯示查看憑證 -->
                                                                <button v-if="isCounterPayment(item.paymentMethod)"
                                                                    class="btn btn-sm btn-outline-primary"
                                                                    @@click="viewPaymentProof(item)">
                                                                    <i class="mdi mdi-eye"></i> 查看憑證
                                                                </button>
                                                                <button class="btn btn-sm btn-success"
                                                                    @@click="approvePayment(item)">
                                                                    <i class="mdi mdi-check"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-danger"
                                                                    @@click="rejectPayment(item)">
                                                                    <i class="mdi mdi-close"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ 預約詳情 Offcanvas (加上付款欄位) -->
    <div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="bookingDrawer" ref="bookingDrawer">
        <div class="offcanvas-header">
            <h5 class="mb-0 fw-bold">
                預約詳情 <small class="text-muted ms-2">#{{ selectedItem?.reservationNo }}</small>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas">
            </button>
        </div>
        <div class="offcanvas-body" v-if="selectedItem">
            <form class="row g-3">
                <!-- ========== 基本資訊 ========== -->
                <div class="col-12">
                    <h6 class="fw-bold border-bottom pb-2">基本資訊</h6>
                </div>

                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">預約者</label>
                        <label class="form-label col-md-9">{{ selectedItem.reserverName }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">預約日期</label>
                        <label class="form-label col-md-8">{{ selectedItem.reservationDate }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">時間</label>
                        <label class="form-label col-md-8">{{ selectedItem.timeSlot }}</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">會議室</label>
                        <label class="form-label col-md-9">{{ selectedItem.roomName }}</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">繳費截止日</label>
                        <label class="form-label col-md-9">{{ selectedItem.paymentDeadline }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">付款方式</label>
                        <label class="form-label col-md-8">{{ getPaymentMethodText(selectedItem.paymentMethod)
                            }}</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label class="form-label col-md-4 fw-bold">金額</label>
                        <label class="form-label col-md-8">NT${{ selectedItem.amount?.toLocaleString() }}</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">成本中心代碼</label>
                        <label class="form-label col-md-9">{{ selectedItem.costCenter || '-' }}</label>
                    </div>
                </div>

                <!-- ========== 審核狀態 ========== -->
                <div class="col-12">
                    <h6 class="fw-bold border-bottom pb-2 mt-3">審核狀態</h6>
                </div>

                <div class="col-md-12">
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">審核狀態</label>
                        <label class="form-label col-md-9">
                            <span class="badge" :class="getApprovalStatusClass(selectedItem.approvalStatus)">
                                {{ selectedItem.approvalStatus }}
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 拒絕原因 -->
                <div class="col-md-12" v-if="selectedItem.approvalStatus === '審核拒絕' && selectedItem.rejectReason">
                    <div class="alert alert-danger" role="alert">
                        <strong><i class="mdi mdi-alert-circle me-2"></i>拒絕原因：</strong>
                        <p class="mb-0 mt-2">{{ selectedItem.rejectReason }}</p>
                    </div>
                </div>

                <!-- ========== 付款狀態 ========== -->
                <div class="col-12">
                    <h6 class="fw-bold border-bottom pb-2 mt-3">付款狀態</h6>
                </div>

                <!-- ✅ 管理員可編輯付款狀態 -->
                <div class="col-md-12" v-if="isAdmin">
                    <label class="form-label fw-bold">付款狀態</label>
                    <select class="form-select" v-model="selectedItem.paymentStatus"
                        :disabled="selectedItem.approvalStatus !== '待繳費' && selectedItem.approvalStatus !== '預約成功'">
                        <option>未付款</option>
                        <option>待查帳</option>
                        <option>已收款(全額)</option>
                        <option>已收款(訂金30%)</option>
                        <option>已收款(尾款70%)</option>
                    </select>

                    <!-- ✅ 如果是「待查帳」狀態,顯示付款資訊 -->
                    <div v-if="selectedItem.paymentStatus === '待查帳'" class="mt-3">
                        <div class="alert alert-info">
                            <h6 class="fw-bold mb-2">
                                <i class="mdi mdi-information-outline me-2"></i>付款資訊
                            </h6>

                            <!-- 現金付款 -->
                            <div v-if="isCounterPayment(selectedItem.paymentMethod)">
                                <p class="mb-2"><strong>付款方式:</strong> 現金付款 (臨櫃)</p>
                                <p class="mb-2"><strong>上傳時間:</strong> {{ selectedItem.uploadTime || '-' }}</p>
                                <p class="mb-2"><strong>備註:</strong> {{ selectedItem.paymentNote || '-' }}</p>

                                <!-- ✅ 憑證預覽/下載 -->
                                <div v-if="selectedItem.proofFiles && selectedItem.proofFiles.length > 0">
                                    <strong>上傳憑證:</strong>
                                    <div class="mt-2 d-flex gap-2 flex-wrap">
                                        <a v-for="(file, index) in selectedItem.proofFiles" :key="index"
                                            :href="file.url" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="mdi mdi-file-document me-1"></i>
                                            {{ file.name }}
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- 匯款付款 -->
                            <div v-if="isTransferPayment(selectedItem.paymentMethod)">
                                <p class="mb-2"><strong>付款方式:</strong> 銀行匯款</p>
                                <p class="mb-2"><strong>轉帳末五碼:</strong> {{ selectedItem.last5 || '-' }}</p>
                                <p class="mb-2"><strong>轉帳金額:</strong> NT${{
                                    selectedItem.transferAmount?.toLocaleString() || '-' }}</p>
                                <p class="mb-2"><strong>轉帳時間:</strong> {{ selectedItem.transferAt || '-' }}</p>
                                <p class="mb-0"><strong>備註:</strong> {{ selectedItem.paymentNote || '-' }}</p>
                            </div>
                        </div>

                        <!-- ✅ 提示:到待查帳頁面批准/退回 -->
                        <div class="alert alert-warning">
                            <i class="mdi mdi-alert me-2"></i>
                            請到「待查帳」頁面進行批准或退回操作
                        </div>
                    </div>

                    <div class="form-text text-danger"
                        v-if="selectedItem.approvalStatus !== '待繳費' && selectedItem.approvalStatus !== '預約成功'">
                        <i class="mdi mdi-alert-circle me-1"></i>
                        {{ selectedItem.approvalStatus === '待審核' ? '請先審核通過後才能修改付款狀態' :
                        selectedItem.approvalStatus === '審核拒絕' ? '已拒絕的預約無法修改付款狀態' :
                        selectedItem.approvalStatus === '已釋放' ? '已釋放的預約無法修改付款狀態' :
                        '此狀態無法修改付款狀態' }}
                    </div>
                </div>

                <!-- ✅ 一般使用者查看付款狀態 + 付款欄位 -->
                <div class="col-md-12" v-else>
                    <div class="row">
                        <label class="form-label col-md-3 fw-bold">付款狀態</label>
                        <label class="form-label col-md-9">
                            <span v-if="selectedItem.paymentStatus === '-'" class="text-muted">-</span>
                            <span v-else class="badge" :class="getPaymentStatusClass(selectedItem.paymentStatus)">
                                {{ selectedItem.paymentStatus }}
                            </span>
                        </label>
                    </div>

                    <!-- ✅ 如果狀態是「待繳費」且「未付款」,顯示付款欄位 -->
                    <div v-if="selectedItem.approvalStatus === '待繳費' && selectedItem.paymentStatus === '未付款'">

                        <!-- ========== 臨櫃付款欄位 ========== -->
                        <div v-if="isCounterPayment(selectedItem.paymentMethod)" class="mt-4">
                            <h6 class="fw-bold mb-3">
                                <i class="mdi mdi-cash-register me-2"></i>
                                {{ selectedItem.amount === 0 ? '上傳證明文件' : '臨櫃付費 - 上傳憑證' }}
                            </h6>

                            <div v-if="selectedItem.amount === 0" class="alert alert-info">
                                <i class="mdi mdi-information me-2"></i>
                                此預約為免費使用，請上傳證明文件(如:公文、許可證明等)
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    {{ selectedItem.amount === 0 ? '上傳證明文件' : '上傳三聯單（影像或 PDF）' }}
                                    <span class="text-danger">*</span>
                                </label>
                                <input class="form-control" type="file" ref="counterPayFiles"
                                    accept=".jpg,.jpeg,.png,.pdf" multiple required>
                                <div class="form-text">可上傳多檔；支援 JPG / PNG / PDF。</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">備註（選填）</label>
                                <textarea class="form-control" v-model="paymentForm.counterNote" rows="2"
                                    placeholder="例：窗口、收據號碼…"></textarea>
                            </div>

                            <button type="button" class="btn btn-primary" @@click="submitCounterPayment">
                                <i class="mdi mdi-upload me-1"></i> 上傳憑證
                            </button>
                        </div>

                        <!-- ========== 匯款付款欄位 ========== -->
                        <div v-if="isTransferPayment(selectedItem.paymentMethod)" class="mt-4">
                            <h6 class="fw-bold mb-3">
                                <i class="mdi mdi-bank-transfer me-2"></i>匯款付費
                            </h6>

                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label">
                                        轉帳末五碼 <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" v-model="paymentForm.last5"
                                        inputmode="numeric" maxlength="5" placeholder="例如:12345" required>
                                    <div class="form-text">請輸入 5 碼數字。</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">
                                        金額 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">NT$</span>
                                        <input type="number" class="form-control" v-model="paymentForm.amount" min="1"
                                            step="1" required>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">轉帳時間（選填）</label>
                                    <input type="datetime-local" class="form-control" v-model="paymentForm.transferAt">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">備註（選填）</label>
                                    <textarea class="form-control" v-model="paymentForm.transferNote" rows="2"
                                        placeholder="例：銀行代碼、分行…"></textarea>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary mt-3" @@click="submitTransferPayment">
                                <i class="mdi mdi-send me-1"></i> 送出匯款資訊
                            </button>
                        </div>

                        <!-- ========== 成本分攤提示 ========== -->
                        <div v-if="isCostSharingPayment(selectedItem.paymentMethod)" class="mt-4">
                            <div class="alert alert-info">
                                <i class="mdi mdi-information me-2"></i>
                                此預約採用「成本分攤」付款方式，無需手動上傳憑證。
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== 操作按鈕 ========== -->
                <div class="col-12 d-flex gap-2 pt-3 border-top" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-primary" @@click="saveDetailChanges" v-if="isAdmin"
                        :disabled="selectedItem.approvalStatus !== '待繳費' && selectedItem.approvalStatus !== '預約成功'">
                        儲存
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">
                        {{ isAdmin ? '取消' : '關閉' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>